events {}

http {
    server {
        listen 80;
        client_max_body_size 1024M;
        proxy_read_timeout 3600s;
        proxy_connect_timeout 3600s;
        proxy_send_timeout 3600s;
        send_timeout 3600s;

        location / {
            proxy_pass http://mobsf:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # Ensure gzipped responses from upstream are decompressed so sub_filter works
            proxy_set_header Accept-Encoding "";

            # 1. Capture scan_hash from URL if present
            # Pattern: /StaticAnalyzer/hash/ or /DynamicAnalyzer/hash/
            # We use map or regex in location?
            # Creating a variable $scan_hash is tricky in pure nginx without Lua.
            # But we can use a simple JS injection that parses URL client-side.
            
            # Inject Chat Button
            sub_filter '</body>' '<script>
            (function() {
                // Parse hash from URL (MobSF standard: /StaticAnalyzer/hash/ or similar)
                const match = window.location.pathname.match(/\/([a-f0-9]{32})\//);
                if (match) {
                    const hash = match[1];
                    const btn = document.createElement("a");
                    btn.href = "/chat/" + hash + "/";
                    btn.target = "_blank";
                    btn.style.cssText = "position:fixed;bottom:20px;right:20px;z-index:9999;width:60px;height:60px;background:#28a745;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);text-decoration:none;";
                    btn.innerHTML = "<span style=\\"color:white;font-size:24px;\\">ðŸ’¬</span>";
                    document.body.appendChild(btn);
                }
            })();
            </script></body>';
            sub_filter_once on;
        }

        # Route /chat/ to sidecar
        location /chat/ {
            proxy_pass http://chat:5000;
        }

        # Route /api/chat to sidecar
        location /api/chat {
            proxy_pass http://chat:5000;
        }
    }
}
